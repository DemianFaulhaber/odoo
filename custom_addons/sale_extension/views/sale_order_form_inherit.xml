<odoo>
    <data> 
        <record id="view_order_form_inherit_item" model="ir.ui.view">
            <field name="name">sale.view_order_form.inherit.item_delivery_time</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='order_line']//form//field[@name='tax_id']" position="before">
                    <field name="item_delivery_date"/>
                </xpath>
            </field>
        </record>

        <record id="view_order_form_inherit_real" model="ir.ui.view">
            <field name="name">sale.view_order_form.inherit.delivery_time</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='partner_id']" position="after">
                    <field name="delivery_date"/>
                </xpath>
            </field>
        </record>

        <record id="view_order_form_inherit_print_button" model="ir.ui.view">
            <field name="name">sale.order.form.print.button</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
            <xpath expr="//button[@name='action_cancel']" position="after">
                <!-- Hidden field to trigger JS - placed at button level for easy access -->
                <field name="sale_status" invisible="0" id="sale_status_trigger" readonly="false" style="opacity: 0; position: absolute; pointer-events: none;"/>
                
                <button name="print_quotation_report"
                        string="Imprimir Presupuesto"
                        type="object"
                        class="btn btn-secondary"
                        icon="fa-print"
                        invisible="quotation_status == 'draft'"/>

                <button name="print_ordernote_report" 
                        string="Imprimir Nota de Pedido"
                        type="object"
                        class="btn btn-secondary"
                        icon="fa-print"
                        invisible="order_note_state != 'finished'"
                />
                <!-- <field name="quotation_status"/> -->
            </xpath>
            </field>
        </record>


        <record id="view_order_form_inherit_hide_fields" model="ir.ui.view">
            <field name="name">sale.order.form.inherit.hide.fields</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form" />
            <field name="arch" type="xml">

                <xpath expr="//field[@name='payment_term_id']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>

                <xpath expr="//page[@name='other_information']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>

                <xpath expr="//page[@name='customer_signature']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>

                <xpath expr="//field[@name='delivery_date']" position="after">
                    <!-- <div class="o_td_label">
                        <label for="delivery_method" string="Lugar de entrega"/>
                    </div> -->
                    <field name="delivery_method" id="delivery_method" string="Lugar de entrega" nolabel="0" on_change="1"/>
                </xpath>

                <xpath expr="//field[@name='date_order']" position="after">
                    <div class="o_td_label" style="display: contents;">
                        <!-- <label for="discount" string="Descuento"/> -->
                    </div>
                    <field name="discount" id="discount" string="Descuento" nolabel="0" on_change="1"/>
                </xpath>

                <xpath expr="//field[@name='date_order']" position="attributes">
                    <attribute name="id">date_order_field</attribute>
                </xpath>
                <xpath expr="//field[@name='validity_date']" position="attributes">
                    <attribute name="id">validity_date_field</attribute>
                </xpath>
                <!-- <xpath expr="//field[@name='partner_id']" position="attributes">
                    <attribute name="readonly">sale_status != 'quotation'</attribute>
                </xpath> -->
                <xpath expr="//field[@name='delivery_date']" position="attributes">
                    <attribute name="id">delivery_date_field</attribute>
                </xpath>
                <xpath expr="//field[@name='delivery_method']" position="attributes">
                    <attribute name="id">delivery_method_field</attribute>
                </xpath>
                <!-- <xpath expr="//field[@name='discount']" position="attributes">
                    <attribute name="readonly">sale_status != 'quotation'</attribute>
                </xpath> -->
                <!-- <xpath expr="//field[@name='taxes']" position="attributes">
                    <attribute name="readonly">sale_status != 'quotation'</attribute>
                </xpath> -->
                <xpath expr="//button[@name='action_preview_sale_order']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
            </field>
        </record>

         <record id="view_order_form_inherit_hide_optional_products" model="ir.ui.view">
            <field name="name">sale.order.form.inherit.hide.optional_products</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale_management.sale_order_form_quote"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='sale_order_template_id']" position="replace">
                </xpath>
                <xpath expr="//page[@name='optional_products']" position="replace">
                    <page name="optional_products" string="Optional Products" invisible="1"/>
                </xpath>
            </field>
        </record>

        <record id="sale_pdf_quote_builder.sale_order_form_inherit_sale_pdf_quote_builder" model="ir.ui.view">
            <field name="active" eval="False"/>
        </record>

        <record id="view_order_form_inherit_notebook_wrapper" model="ir.ui.view">
            <field name="name">sale.order.form.inherit.notebook.wrapper</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <!-- Agregar una nueva página al notebook existente -->
                <xpath expr="//notebook" position="inside">
                    <page 
                    string="Nota de pedido" 
                    name="order_note"
                    id="tab_order_note"
                    invisible="sale_status == 'quotation'">
                        <group col="2">
                            <group>
                                <field name="order_note_id" string="Nota de pedido" 
                                style="pointer-events:none;cursor:not-allowed;" id="order_note_id_field"/>
                                <field name="buy_order" string="Estado nota de compra" id="buy_order_field"/>
                                <field name="buy_order_number" string="Número de nota de compra" 
                                       invisible="buy_order != 'number'" 
                                       id="buy_order_number_field"/>
                                <field name="buy_order_date" string="Fecha de nota de compra" id="buy_order_date_field"/>
                            </group>
                            <group>
                                <field name="order_note_state" string="Estado nota de pedido" readonly="0" id="order_note_state_field"/>
                                <field name="order_note_date" string="Fecha de nota de pedido" id="order_note_date_field"/>
                            </group>
                        </group>
                    </page>
                    <page 
                    string="Remitos" 
                    name="remitos"
                    id="tab_remitos"
                    invisible="sale_status in ['quotation', 'sale_order']">
                        <group col="3">
                            <group>
                                <field name="remito_status" string="Estado remito" readonly="0" id="remito_status_field"/>
                            </group>
                            <group>
                                <field name="remito_number" string="Número de remito" id="remito_number_field"/>
                            </group>
                            <group>
                                <field name="remito_date" string="Fecha de remito" id="remito_date_field"/>
                            </group>
                        </group>
                    </page>
                    <page 
                    string="Factura" 
                    name="factura"
                    id="tab_factura"
                    invisible="sale_status in ['quotation', 'sale_order', 'remito']">
                        <group col="3">
                            <group>
                                <field name="bill_number" class="o_field_widget o_field_many2one" id="bill_number_field"/>
                            </group>
                            <group>
                                <field name="bill_status" class="o_field_widget o_field_many2one" id="bill_status_field"/>
                            </group>
                            <group>
                                <field name="bill_date" class="o_field_widget o_field_many2one" id="bill_date_field"/>
                            </group>
                        </group>
                    </page>
                </xpath>
                <!-- Replace control sections to only show desired buttons -->
                <!-- Replace list view control -->
                <xpath expr="//field[@name='order_line']//list//control" position="replace">
                    <control>
                        <create name="add_product_control" string="Add a product"/>
                        <button name="action_add_from_catalog" string="Catalog" type="object" class="px-4 btn-link" context="{'order_id': parent.id}"/>
                    </control>
                </xpath>
                <!-- Replace kanban view control -->
                <xpath expr="//field[@name='order_line']//kanban//control" position="replace">
                    <control>
                        <create name="add_product_control" string="Add product"/>
                        <button name="action_add_from_catalog"
                                context="{'order_id': parent.id}"
                                string="Catalog"
                                type="object"
                                class="btn-secondary"/>
                    </control>
                </xpath>
            </field>
        </record>

        <record id="view_order_form_inherit_pricelist_discount_taxes" model="ir.ui.view">
            <field name="name">sale.order.form.inherit.pricelist.discount.taxes</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <!-- Hide pricelist field -->
                <xpath expr="//field[@name='pricelist_id']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                
                <!-- Make discount field modifiable and add taxes field -->
                <xpath expr="//field[@name='discount']" position="attributes">
                    <attribute name="id">discount_field</attribute>
                </xpath>
                
                <xpath expr="//field[@name='discount']" position="after">
                    <div class="o_td_label" style="display: contents;">
                        <!-- <label for="taxes" string="Impuestos (%)"/> -->
                    </div>
                    <field name="taxes" id="taxes" string="Impuestos (%)" nolabel="0" on_change="1"/>
                </xpath>
                <xpath expr="//field[@name='taxes']" position="after">
                    <div class="o_td_label" style="display: contents;">
                        <!-- <label for="quotation_status" string="Estado de Presupuesto"/> -->
                    </div>
                    <field name="quotation_status" id="quotation_status" string="Estado de Presupuesto" nolabel="0" on_change="1" readonly="0"/>
                </xpath>
            </field>
        </record>

        <!--templates-->

        <template id="report_saleorder_document_inherit_delivery_date" inherit_id="sale.report_saleorder_document">
            <xpath expr="//div[@id='informations']" position="before">
                <div class ="row">
                    <div class="col-6">
                        <strong>Fecha de Entrega:</strong>
                        <div t-field="doc.delivery_date"/>
                    </div>
                    <div class="col-6">
                        <strong>Lugar de entrega:</strong>
                        <div t-field="doc.delivery_method"/>
                    </div>
                </div>
            </xpath>
        </template>

        <record id="view_order_form_inherit_custom_totals" model="ir.ui.view">
            <field name="name">sale.order.form.inherit.custom.totals</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <!-- Replace the default totals section with our custom breakdown -->
                <xpath expr="//group[@name='sale_total']" position="replace">
                    <group class="oe_subtotal_footer d-flex order-0 order-lg-1 flex-column gap-0 gap-sm-3" colspan="2" name="custom_sale_total">
                        <div class="oe_subtotal_footer oe_right">
                            <table class="table table-sm">
                                <tbody>
                                    <!-- Untaxed Amount -->
                                    <tr class="o-border-bottom">
                                        <td><strong>Subtotal:</strong></td>
                                        <td class="text-end">
                                            <field name="amount_untaxed_before_discount" widget="monetary" nolabel="1"/>
                                        </td>
                                    </tr>
                                    <!-- Discount row - only show if discount > 0 -->
                                    <tr invisible="not discount" class="o-border-bottom">
                                        <td> 
                                            <strong>Descuento </strong>
                                            (<field name="discount" nolabel="1" readonly="1" style="display: contents;"/>%): 
                                        </td>
                                        <td class="text-end">
                                            <field name="amount_discount" widget="monetary" nolabel="1"/>
                                        </td>
                                    </tr>
                                    <!-- Subtotal after discount -->
                                    <!-- <tr>
                                        <td>Subtotal:</td>
                                        <td class="text-end">
                                            <field name="amount_untaxed_after_discount" widget="monetary" nolabel="1"/>
                                        </td>
                                    </tr> -->
                                    <!-- Taxes row - only show if taxes > 0 -->
                                    <tr class="o-border-bottom" invisible="not taxes" >
                                        <td>
                                            <strong>Impuestos </strong>
                                            (<field name="taxes" nolabel="1" readonly="1" style="display: contents;"/>%):
                                        </td>
                                        <td class="text-end">
                                            <field name="amount_tax" widget="monetary" nolabel="1"/>
                                        </td>
                                    </tr>
                                    <!-- Total -->
                                    <tr class="fw-bolder o_total">
                                        <td><strong>Total:</strong></td>
                                        <td class="text-end">
                                            <field name="amount_total" widget="monetary" nolabel="1"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </group>
                </xpath>
            </field>
        </record>

    </data>
</odoo>
